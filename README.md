# Numbers Core

Проект Numbers Core состоит из трёх взаимодополняющих частей: чистого Python-пакета с вычислениями, REST‑API на FastAPI и настольного клиента на Godot 4. Ниже описано, как устроена архитектура, как подготовить рабочее окружение и как пользоваться приложением.

## Архитектура репозитория

- `numbers_core/` — модуль с нумерологическими расчётами, вспомогательными функциями и обёрткой над AI‑анализом. Внутри можно найти подмодули:
  - `calc/` — все числовые вычисления (жизненный путь, годы, совместимость и т.п.);
  - `core/` — оркестратор, который проверяет ввод и собирает расчёт целиком;
  - `intelligence/` — интеграция с OpenRouter и шаблоны промптов для генерации текста.
- `api.py` — приложение FastAPI с двумя эндпоинтами (`/profile`, `/profile/analysis`), которое предоставляет REST‑доступ к расчётам.
- `numbers-gui/` — Godot 4 проект. После рефакторинга логика разбита на отдельные скрипты в `numbers-gui/scripts/`, а `main.gd` служит лёгкой «склейкой» визуальных элементов и вспомогательных классов.
- `pyproject.toml`, `requirements.txt` — управление зависимостями для Python-части.
- `.env` (создаётся вручную) — хранит секреты и настройки, например `OPENROUTER_API_KEY`.

## Установка зависимостей

```bash
python -m venv .venv
.\.venv\Scripts\activate  # Windows
# source .venv/bin/activate  # macOS / Linux
pip install -r requirements.txt
```

### Переменные окружения

Чтобы задействовать AI‑анализ, создайте файл `.env` в корне репозитория и укажите ключ OpenRouter:

```
OPENROUTER_API_KEY=ваш_ключ
```

Если ключ не задан, система автоматически переключается на `MockAIClient` — расчёты выполняются, а вместо анализа возвращается заглушка.

## Запуск REST‑API

```bash
uvicorn api:app --reload --port 8000
```

После запуска доступны следующие маршруты:

| Метод | Путь                 | Описание                                       |
|-------|----------------------|------------------------------------------------|
| POST  | `/profile`           | Возвращает “чистый” нумерологический профиль. |
| POST  | `/profile/analysis`  | Профиль + запрос AI‑анализа (при наличии ключа). |

Пример запроса к `/profile`:

```bash
curl -X POST http://127.0.0.1:8000/profile \
     -H "Content-Type: application/json" \
     -d "{\"full_name\": \"Иван Иванов\", \"birthdate\": \"01.02.1990\"}"
```

Ответ содержит поля `life_path`, `birthday`, `expression`, `soul`, `personality`. Для `/profile/analysis` дополнительно возвращается поле `analysis` (строка с текстом от AI).

## Godot‑клиент

### Быстрый старт

1. Запустите FastAPI на `http://127.0.0.1:8000` (см. выше).
2. Откройте `numbers-gui/main.tscn` в Godot 4 и запустите сцену (`F5`).
3. Пройдите шаги мастера: введите ФИО (минимум имя + фамилия) и дату рождения в формате `ДД.ММ.ГГГГ`.
4. Получите профиль. Кнопка `AI анализ` станет активной и отправит запрос на `/profile/analysis`.
5. Дополнительные кнопки пока выводят подсказки, но в будущем могут быть привязаны к подсистемам совместимости и циклов.

### Структура Godot‑логики

- `main.gd` — главный скрипт сцены, который управляет отображением и подписывается на сигналы помощников.
- `scripts/profile_service.gd` — обёртка над `HTTPRequest`. Отправляет POST‑запросы, обрабатывает коды ответа и выбрасывает удобные сигналы (`profile_ready`, `analysis_ready`, `request_failed`).
- `scripts/input_flow.gd` — хранит состояние мастера (шаги NAME/DATE/RESULT), валидирует ввод регулярными выражениями и возвращает сообщения для UI.
- `scripts/profile_presenter.gd` — форматирует словарь профиля в многострочный текст и соединяет его с AI‑анализом.
- `scripts/extras_controller.gd` — временные подсказки для кнопок «совместимость», «личные годы» и т.д.

Если необходимо подключить API, работающий не на `127.0.0.1:8000`, измените экспортированные свойства `profile_endpoint` и `analysis_endpoint` в `scripts/profile_service.gd` (это можно сделать прямо в инспекторе Godot).

## Тестирование

```bash
python -m pytest numbers_core/tests
```

Набор покрывает основные сценарии:

- корректность расчётов в модуле `calc`;
- валидацию ввода в `core.orchestrator`;
- поведение оркестратора при подмене AI‑клиента.

Рекомендуется запускать тесты перед внесением правок в Python‑часть, а Godot‑клиент проверять вручную (поскольку Godot-скрипты не покрываются pytest).

## FAQ

**Нужен ли интернет для работы приложения?**  
Нет, если вы не используете AI‑анализ. Основные расчёты выполняются локально. Для AI нужен доступ к сервису OpenRouter и действующий ключ.

**Где редактировать промпты для AI?**  
В каталоге `numbers_core/intelligence/prompts`. Шаблоны пишутся на Markdown и обрабатываются через Jinja2.

**Можно ли расширить Godot‑клиент дополнительными экранами?**  
Да. Рекомендуется создавать новые узлы/скрипты рядом, а основной `main.gd` держать в роли координатора, чтобы логика оставалась модульной.

**Поддерживаются ли другие форматы дат?**  
На стороне API предусмотрены варианты `YYYY-MM-DD`, `DD.MM.YYYY`, `DD/MM/YYYY`, `DD-MM-YYYY`. Godot-клиент по умолчанию ждёт `ДД.ММ.ГГГГ`, но формат легко изменить в `input_flow.gd`.

**Как внести изменения?**  
Открывайте issue или создавайте pull request. Для Godot‑части придерживайтесь выделенных ролей скриптов (service / flow / presenter / extras), чтобы сцена оставалась читаемой.
