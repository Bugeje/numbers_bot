# Высокая производительность бота

## Настройка для работы с множеством пользователей

### 1. Конфигурация окружения

Для обеспечения высокой производительности рекомендуется использовать следующие настройки в файле `.env`:

```env
# Основные настройки
ENVIRONMENT=production
DEBUG=false

# Настройки HTTP клиента
HTTP_TIMEOUT=45.0
CONNECTION_POOL_SIZE=200
MAX_KEEPALIVE_CONNECTIONS=100
KEEPALIVE_EXPIRY=30.0

# Настройки производительности
MAX_CONCURRENT_REQUESTS=200
THREAD_POOL_SIZE=100
AI_SEMAPHORE_LIMIT=100
PDF_SEMAPHORE_LIMIT=50

# Настройки Telegram
TELEGRAM_MAX_CONNECTIONS=200
TELEGRAM_READ_TIMEOUT=30.0
TELEGRAM_WRITE_TIMEOUT=30.0
TELEGRAM_CONNECT_TIMEOUT=10.0
TELEGRAM_POOL_TIMEOUT=5.0

# Настройки безопасности
SECURITY_RATE_LIMIT_PER_MINUTE=100
SECURITY_MAX_FILE_SIZE_MB=10
```

### 2. Системные требования

#### Минимальные требования для 50+ одновременных пользователей:
- **CPU**: 2 ядра
- **RAM**: 4 ГБ
- **Диск**: 10 ГБ свободного места

#### Рекомендуемые требования для 100+ одновременных пользователей:
- **CPU**: 4 ядра
- **RAM**: 8 ГБ
- **Диск**: 20 ГБ SSD

### 3. Оптимизация производительности

#### 3.1. Настройка пула соединений
Бот использует пул HTTP-клиентов для оптимизации соединений с AI API:
- По умолчанию создается 5 клиентов в пуле
- Каждый клиент имеет свои собственные настройки соединений
- Это предотвращает блокировку при множественных запросах

#### 3.2. Система очередей
Для обработки длительных операций используется система очередей:
- **Очередь PDF**: отдельные воркеры для генерации PDF
- **Фоновые задачи**: длительные операции выполняются в фоне
- **Семафоры**: контроль количества одновременных операций

#### 3.3. Параллельная обработка обновлений
Бот использует `concurrent_updates=True` для параллельной обработки сообщений от пользователей:
- Несколько обновлений обрабатываются одновременно
- Пользователи не блокируют друг друга
- Ответы отправляются немедленно

### 4. Мониторинг производительности

#### 4.1. Логирование
Все ключевые операции логируются:
- AI-запросы
- PDF-генерация
- Ошибки и предупреждения
- Метрики производительности

#### 4.2. Метрики
Доступны метрики для мониторинга:
- Количество активных соединений
- Время обработки запросов
- Количество успешных/неуспешных операций
- Использование ресурсов

### 5. Масштабирование

#### 5.1. Вертикальное масштабирование
Для увеличения производительности на одной машине:
1. Увеличьте лимиты семафоров в конфигурации
2. Увеличьте размеры пулов соединений
3. Добавьте больше воркеров для очередей

#### 5.2. Горизонтальное масштабирование
Для работы с 500+ пользователями:
1. Используйте Redis для распределенного кэширования
2. Добавьте балансировщик нагрузки
3. Разверните несколько инстансов бота
4. Используйте базу данных для хранения состояния

### 6. Решение проблем производительности

#### 6.1. Проблемы с AI-запросами
**Симптомы**: 
- Долгое время ответа
- Ошибки таймаута

**Решения**:
- Проверьте лимиты API-ключа
- Увеличьте таймауты
- Проверьте подключение к интернету

#### 6.2. Проблемы с PDF-генерацией
**Симптомы**:
- Ошибки генерации PDF
- Высокое использование памяти

**Решения**:
- Проверьте установку WeasyPrint
- Увеличьте лимиты памяти
- Оптимизируйте шаблоны HTML/CSS

#### 6.3. Проблемы с параллелизмом
**Симптомы**:
- Пользователи блокируют друг друга
- Долгое время отклика

**Решения**:
- Проверьте настройку `concurrent_updates`
- Увеличьте лимиты семафоров
- Проверьте систему очередей